#' Format model results for publication-ready display
#' @keywords internal
format_model_table <- function(data, 
                               effect_col = NULL,
                               digits = 2, 
                               digits_p = 3, 
                               var_labels = NULL,
                               show_n = TRUE,
                               show_events = TRUE,
                               reference_label = "reference",
                               exponentiate = NULL) {
    
    result <- data.table::copy(data)

    ## Disallow "Events" column if linear model 
    if ("model_type" %in% names(result)) {
        model_type <- unique(result$model_type)[1]
        if (grepl("Linear", model_type, ignore.case = TRUE)) {
            show_events <- FALSE
        }
    }
    
    ## Standardize column names
    if ("variable" %in% names(result)) {
        setnames(result, "variable", "Variable")
    }
    if ("group" %in% names(result)) {
        setnames(result, "group", "Group")
    }

    ## Handle the exponentiate parameter to choose which columns to use
    if (!is.null(exponentiate)) {
        if (exponentiate && "exp_coef" %in% names(result)) {
            ## Check model type
            if ("OR" %in% names(result)) {
                effect_col <- "OR"
            } else if ("HR" %in% names(result)) {
                effect_col <- "HR"
            } else if ("RR" %in% names(result)) {
                effect_col <- "RR"
            } else {
                ## Generic model - create OR/RR based on model type
                model_type <- unique(result$model_type)[1]
                if (grepl("Logistic", model_type)) {
                    result[, `:=`(
                        OR = exp_coef,
                        CI_lower = exp_lower,
                        CI_upper = exp_upper
                    )]
                    effect_col <- "OR"
                } else if (grepl("Poisson", model_type)) {
                    result[, `:=`(
                        RR = exp_coef,
                        CI_lower = exp_lower,
                        CI_upper = exp_upper
                    )]
                    effect_col <- "RR"
                } else {
                    result[, `:=`(
                        Estimate = exp_coef,
                        CI_lower = exp_lower,
                        CI_upper = exp_upper
                    )]
                    effect_col <- "Estimate"
                }
            }
        } else if (!exponentiate && "coef" %in% names(result)) {
            result[, `:=`(
                Estimate = coef,
                CI_lower = coef_lower,
                CI_upper = coef_upper
            )]
            effect_col <- "Estimate"
        }
    }
    
    ## Auto-detect effect column if not specified
    if (is.null(effect_col)) {
        effect_col <- intersect(c("OR", "HR", "RR", "Estimate"), names(result))[1]
        if (length(effect_col) == 0) {
            stop("No effect measure column found (OR, HR, RR, or Estimate)")
        }
    }
    
    ## Apply variable labels if provided - OPTIMIZED
    if (!is.null(var_labels) && "Variable" %in% names(result) && length(var_labels) > 0) {
                                        # Vectorized lookup using data.table join
        label_dt <- data.table::data.table(
                                    var_orig = names(var_labels),
                                    var_new = unname(unlist(var_labels))
                                )
        
                                        # Update using merge (more efficient for many labels)
        result[label_dt, Variable := i.var_new, on = .(Variable = var_orig)]
    }
    
    ## Clean up Group display (handle empty groups for continuous vars)
    if ("Group" %in% names(result)) {
        result[Group == "", Group := "-"]
    }

    ## Format sample size BEFORE eliminating repeated variable names - OPTIMIZED
    if ("n" %in% names(result)) {
                                        # Use n_group where available, otherwise use n
        if ("n_group" %in% names(result)) {
            result[!is.na(n_group), n := n_group]
        }
        
                                        # Convert to character and format with commas in one step
        result[, n := data.table::fcase(
                                      is.na(n), NA_character_,
                                      n >= 1000, format(n, big.mark = ","),
                                      default = as.character(n)
                                  )]
    }

    ## Similar optimization for events
    if ("events" %in% names(result)) {
        if ("events_group" %in% names(result)) {
            result[!is.na(events_group), events := events_group]
        }
        
        result[, events := data.table::fcase(
                                           is.na(events), NA_character_,
                                           events >= 1000, format(events, big.mark = ","),
                                           default = as.character(events)
                                       )]
    }
    
    ## Eliminate repeated variable names - OPTIMIZED VECTORIZED VERSION
    if ("Variable" %in% names(result) && nrow(result) > 1) {
                                        # Create a logical vector indicating where variable changes
                                        # TRUE for first occurrence, FALSE for repeats
        n_rows <- nrow(result)
        is_new_var <- c(TRUE, result$Variable[-1] != result$Variable[-n_rows])
        
                                        # Set non-first occurrences to empty string
        result[!is_new_var, Variable := ""]
    }
    
    ## Create effect column label based on model scope
    model_scope <- if ("model_scope" %in% names(result)) {
                       unique(result$model_scope)[1]
                   } else {
                       "Effect"
                   }
    
    ## Create appropriate label
    if (model_scope == "Univariable") {
        effect_label <- paste0("Univariable ", effect_col, " (95% CI)")
    } else if (model_scope == "Multivariable") {
        adjusted_col <- if (effect_col == "OR") "aOR" 
                        else if (effect_col == "HR") "aHR"
                        else if (effect_col == "RR") "aRR"
                        else effect_col
        effect_label <- paste0("Multivariable ", adjusted_col, " (95% CI)")
    } else {
        effect_label <- paste0(effect_col, " (95% CI)")
    }
    
    ## Format effect sizes with CI
    if ("CI_lower" %in% names(result) && "CI_upper" %in% names(result)) {
        is_reference <- FALSE
        if ("reference" %in% names(result)) {
            is_reference <- !is.na(result$reference) & result$reference == reference_label
        }
        
        if (effect_col %in% c("OR", "HR", "RR")) {
            result[, (effect_label) := data.table::fcase(
                                                       is_reference, reference_label,
                                                       !is.na(get(effect_col)), sprintf("%.*f (%.*f-%.*f)",
                                                                                        digits, get(effect_col),
                                                                                        digits, CI_lower,
                                                                                        digits, CI_upper),
                                                       default = ""
                                                   )]
        } else {
            result[, (effect_label) := data.table::fcase(
                                                       is_reference, reference_label,
                                                       !is.na(get(effect_col)), sprintf("%.*f (%.*f, %.*f)",
                                                                                        digits, get(effect_col),
                                                                                        digits, CI_lower,
                                                                                        digits, CI_upper),
                                                       default = ""
                                                   )]
        }
    }
    
    ## Format p-values
    if ("p_value" %in% names(result)) {
        result[, `p-value` := format_pvalues_fit(p_value, digits_p)]
        
        if ("reference" %in% names(result)) {
            result[!is.na(reference) & reference == reference_label, `p-value` := "-"]
        }
    }

    ## Select columns for final output
    display_cols <- character()
    
    if ("Variable" %in% names(result)) display_cols <- c(display_cols, "Variable")
    if ("Group" %in% names(result)) display_cols <- c(display_cols, "Group")

    if ((show_n) && ("n" %in% names(result))) {
        display_cols <- c(display_cols, "n")
    }
    
    if ((show_events) && ("events" %in% names(result))) {
        display_cols <- c(display_cols, "events")
    }
    
    if (effect_label %in% names(result)) display_cols <- c(display_cols, effect_label)
    if ("p-value" %in% names(result)) display_cols <- c(display_cols, "p-value")
    
    formatted <- result[, ..display_cols]

    if ("events" %in% names(formatted)) {
        setnames(formatted, "events", "Events")
    }

    return(formatted)
}

#' Format p-values for display - OPTIMIZED
#' @keywords internal
format_pvalues_fit <- function(p, digits = 3) {
    data.table::fcase(
                    is.na(p), "-",
                    p < 0.001, "< 0.001",
                    default = sprintf(paste0("%.", digits, "f"), p)
                )
}
